<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Addicts Agenda</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Custom styles for card background gradients and transitions */
    .card-area-blue {
      background: linear-gradient(135deg, #5B86E5 0%, #36D1DC 100%);
    }

    .card-area-green {
      background: linear-gradient(135deg, #2ECC71 0%, #56C87C 100%);
    }

    .card-area-orange {
      background: linear-gradient(135deg, #C0392B 0%, #E74C3C 100%);
    }

    .card-area-purple {
      background: linear-gradient(135deg, #A569BD 0%, #D2B4DE 100%);
    }

    /* Styles for collapsible sections in workbooks */
    .section-content {
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.5s ease-out, opacity 0.5s ease-out, padding 0.5s ease-out;
    }

    .section-content.collapsed {
      max-height: 0;
      opacity: 0;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      margin-top: 0 !important;
    }
     .collapse-icon {
      transition: transform 0.3s;
    }
    .collapsed .collapse-icon {
      transform: rotate(-90deg);
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center font-sans p-4">
  <div class="w-full max-w-3xl">
    <!-- 1. HOME SCREEN -->
    <div id="homeScreen" style="display:block;">
      <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-7 text-center relative">
        <img src="https://placehold.co/100x100/3b82f6/ffffff?text=AA" alt="The Addicts Agenda Logo" class="w-24 h-24 mx-auto mb-5 rounded-full shadow-md">
        <div id="appVersion" class="absolute top-4 left-4 text-xs sm:text-sm text-gray-400 font-medium">V1.3</div>
        <div class="absolute top-4 right-4">
          <button id="goToSettingsBtn" class="text-2xl text-gray-500 p-1 transition-transform duration-300 hover:rotate-45 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-full" title="Settings">&#x2699;</button>
        </div>
        <h1 class="text-3xl font-bold text-gray-800">The Addicts Agenda</h1>
        <p class="text-gray-500 mt-2">Find inspiration and practical tools for your recovery journey.</p>
        <p id="homeSobrietyDuration" class="my-4 text-base sm:text-lg font-semibold text-blue-600">Set your sober date in Settings.</p>
        <div class="mt-8 p-5 bg-blue-50 border border-blue-200 rounded-xl text-center">
          <h2 class="text-base font-bold text-blue-600 mt-0 mb-2.5">Recovery Fact of the Day</h2>
          <p id="dailyFactText" class="text-sm sm:text-base text-gray-700 m-0 italic">Loading daily inspiration...</p>
        </div>
        <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <button id="goToCardsBtn" class="w-full py-3 px-5 rounded-xl border-0 bg-blue-600 text-white text-lg font-semibold shadow-lg shadow-blue-500/30 cursor-pointer transition-colors duration-200 hover:bg-blue-700 sm:col-span-2">Draw a Coping Card</button>
          <button id="goToJournalBtn" class="w-full py-3 px-5 rounded-xl border-0 bg-blue-600 text-white text-lg font-semibold shadow-lg shadow-blue-500/30 cursor-pointer transition-colors duration-200 hover:bg-blue-700">Start Journaling</button>
          <button id="goToTodoBtn" class="w-full py-3 px-5 rounded-xl border-0 bg-blue-600 text-white text-lg font-semibold shadow-lg shadow-blue-500/30 cursor-pointer transition-colors duration-200 hover:bg-blue-700">View To Do List</button>
          <button id="goToReflectionBtn" class="w-full py-3 px-2 rounded-xl border-0 bg-blue-600 text-white text-lg font-semibold shadow-lg shadow-blue-500/30 cursor-pointer transition-colors duration-200 hover:bg-blue-700">Daily Reflection (AA)</button>
          <button id="goToJFTBtn" class="w-full py-3 px-2 rounded-xl border-0 bg-blue-600 text-white text-lg font-semibold shadow-lg shadow-blue-500/30 cursor-pointer transition-colors duration-200 hover:bg-blue-700">Just for Today (NA)</button>
          <button id="goToLiteratureBtn" class="w-full py-3 px-5 rounded-xl border-0 bg-blue-600 text-white text-lg font-semibold shadow-lg shadow-blue-500/30 cursor-pointer transition-colors duration-200 hover:bg-blue-700">Recovery Literature</button>
          <button id="goToWorkbooksBtn" class="w-full py-3 px-5 rounded-xl border-0 bg-blue-600 text-white text-lg font-semibold shadow-lg shadow-blue-500/30 cursor-pointer transition-colors duration-200 hover:bg-blue-700">Recovery Workbooks</button>
        </div>
      </div>
    </div>

    <!-- CARD VIEW SCREEN -->
    <div id="cardView" style="display:none;">
      <div id="cardArea" class="min-h-[420px] rounded-2xl p-6 pt-10 flex flex-col items-center justify-between shadow-lg text-center transition-all duration-500 ease-in-out text-white">
        <div>
          <span id="cardIcon" class="text-7xl sm:text-8xl leading-none mb-3"></span>
          <div id="cardSuit" class="text-xl sm:text-2xl font-semibold uppercase"></div>
        </div>
        <p id="cardText" class="text-xl sm:text-2xl font-medium my-5 sm:my-10 px-2 sm:px-5"></p>
        <div class="flex justify-center gap-4">
          <button id="nextBtn" class="bg-white/30 backdrop-blur-sm text-white py-2.5 px-6 rounded-lg font-semibold transition-all duration-200 shadow-md hover:bg-white/40">Next Card</button>
          <button id="journalBtn" class="bg-white/30 backdrop-blur-sm text-white py-2.5 px-6 rounded-lg font-semibold transition-all duration-200 shadow-md hover:bg-white/40">Journal</button>
          <button id="resetBtn" class="bg-white/30 backdrop-blur-sm text-white py-2.5 px-6 rounded-lg font-semibold transition-all duration-200 shadow-md hover:bg-white/40">Home</button>
        </div>
        <div id="statusText" class="text-sm text-white/80 mt-4"></div>
      </div>
    </div>

    <!-- GENERIC CONTENT CARD VIEW -->
    <div id="contentCardView" class="bg-white p-6 rounded-2xl shadow-lg w-full box-border" style="display:none;">
      <h2 id="contentCardTitle" class="text-2xl sm:text-3xl font-bold mt-0 text-gray-800 text-center"></h2>
      <p id="contentCardSub" class="text-gray-500 text-center mb-6"></p>
      <div id="contentCardBody">
        <!-- Dynamic Content -->
      </div>
    </div>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- START: DATA ---
        const AppData = {
            cards: [{ suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Tense and then relax your muscles. Repeat 3 times.' }, { suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Do 10 jumping jacks or jog in place for 30 seconds.' }, { suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Stretch your entire body for 60 seconds.' }, { suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Go for a walk, even if it is just a lap around the house.' }, { suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Take 5 deep breaths, focusing only on the air moving in and out.' }, { suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Clean an area of your home for 5 minutes (e.g., wash a few dishes).' }, { suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Do a quick chore like taking out the trash or folding one piece of laundry.' }, { suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Drink a full glass of water or a soothing hot beverage.' }, { suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Splash cold water on your face.' }, { suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Change your location. Move to another room or step outside.' }, { suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Do a 2-minute wall sit or plank.' }, { suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Hold ice in your hand for a minute until the feeling subsides.' }, { suit: 'Action & Movement', suit_key: 'blue', icon: 'ðŸƒâ€â™‚ï¸', text: 'Eat a small, healthy snack, like a piece of fruit.' }, { suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Use a grounding technique. Name 5 things you see, 4 you touch, 3 you hear, 2 you smell, 1 you taste.' }, { suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Write down three things you are grateful for right now.' }, { suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Picture a favorite memory, like a vacation or a celebration. Focus on the details.' }, { suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Say a positive affirmation out loud 10 times.' }, { suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Watch a funny video or read a lighthearted article.' }, { suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Try to recall the lyrics to your favorite song, word for word.' }, { suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Look at a complex image or pattern and try to find a repeating element.' }, { suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Do a quick Sudoku or word search puzzle.' }, { suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Listen to a guided meditation for 5 minutes.' }, { suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Imagine the feeling of the craving passing and how good it will feel.' }, { suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Read a book or news article for 5 minutes.' }, { suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Do a body scan. Focus on each part of your body from head to toe.' }, { suit: 'Mind & Focus', suit_key: 'green', icon: 'ðŸ§ ', text: 'Mentally list all the cities or states you can remember.' }, { suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Call or text a supportive friend or family member.' }, { suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Check in with your sponsor or accountability partner.' }, { suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Send a quick encouraging text to someone else in recovery.' }, { suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Write down a commitment you can share with a friend later.' }, { suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Read a few passages from an inspirational book or literature.' }, { suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Go online to find a quick, virtual support meeting.' }, { suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Write a quick email or note to thank someone in your life.' }, { suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Say your name and what you are feeling right now out loud to an empty room.' }, { suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Think about who in your life you could help with something small today.' }, { suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Reach out to a professional (therapist, doctor) for advice if the craving persists.' }, { suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Talk to a pet or plant for 5 minutes.' }, { suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Offer a genuine compliment to a stranger or person nearby.' }, { suit: 'Connection & Support', suit_key: 'orange', icon: 'ðŸ’¬', text: 'Read through old notes or cards from loved ones.' }, { suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Write a short story or poem about your current feeling.' }, { suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Listen to a piece of classical music youâ€™ve never heard before.' }, { suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Draw or doodle for 5 minutes without judging the result.' }, { suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Watch a short documentary or educational video on a random topic.' }, { suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Pick up a new musical instrument (even a simple one) and try it.' }, { suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Look up a recipe and plan to make it later this week.' }, { suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Browse an online museum or art gallery.' }, { suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Start a journal entry about your goals for the next month.' }, { suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Learn a few words in a new language using an app or website.' }, { suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Write down the ABCs backwards.' }, { suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Look up the definition of a word you donâ€™t know and use it in a sentence.' }, { suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Do something tactile, like playing with modeling clay or sand.' }, { suit: 'Creative & Learning', suit_key: 'purple', icon: 'ðŸŽ¨', text: 'Try to balance an object on your finger for 60 seconds.' }],
            DEFAULT_PROMPTS: [{ name: "None (Free Write)", template: "" }, { name: "HALT Check-in", template: "Hungry: Am I hungry? What can I eat?\nAngry: What am I angry about? How can I safely express it?\nLonely: Who can I reach out to right now?\nTired: What rest do I need? How can I relax?" }, { name: "Coping Card Reflection", template: "The card I drew today was: [Insert Card Text Here]\nHow did I use this coping skill?\nWhat was the result?\nWhat craving did I overcome today?" }, { name: "Today's Gratitude", template: "I am grateful for 3 big things today:\n1.\n2.\n3.\nI am grateful for 3 small things today:\n1.\n2.\n3." }, { name: "Future Goal Setting", template: "One small recovery goal for tomorrow is:\nOne large life goal I'm moving toward is:\nWhat steps can I take today to prepare for tomorrow?" }],
            WORKBOOK_STEP_DATA: {
                step1: { title: "Step 1: Powerlessness & Unmanageability", questions: [{ title: "Part 1: Powerlessness", isSection: true }, "In your own words, what does powerless mean to you regarding your addiction?", "Describe your attempts to control your use. Did you ever set rules? What was the result?", "Once you start using, can you reliably control the amount you'll take or how long it will last? Share examples.", "Have you ever made sincere promises to yourself or others that you would stop, only to use again? How did that feel?", "How much of your daily thinking was obsessed with your addiction (planning, hiding, recovering)?", "Did you ever continue to use even when you knew it would lead to negative consequences?", "Have you done things while active in your addiction that went against your core values?", "Describe the physical craving you've experienced. What did it feel like?", "How did your personality change when you were using?", "Why haven't willpower and self-knowledge been enough to keep you sober?", { title: "Part 2: Unmanageability", isSection: true }, "What does unmanageable mean in the context of your life? List five specific examples.", "How has your addiction damaged your relationships? Have dishonesty and unreliability become normal?", "In what ways did your use affect your job or school performance?", "Be brutally honest about the financial cost of your addiction. How much has it consumed?", "How has your use impacted your physical health?", "What has been the effect of your use on your mental and emotional health (paranoia, anxiety, depression)?", "Have you neglected important responsibilities (hygiene, bills, family)?", "Has your addiction ever put you or others in dangerous situations?", "Did you start isolating yourself or avoiding people and situations where you couldn't use?", "How has your addiction impacted your spiritual life or moral compass?", { title: "Part 3: Acceptance and Surrender", isSection: true }, "What doubts or reservations do you still have about admitting you are an addict?", "What have been the consequences of denying the severity of your problem?", "Looking back, can you identify when your use crossed the line into a destructive obsession?", "If nothing changes, what will your life look like in one year? In five years?", "Do you truly believe you are powerless over your addiction and that your life is unmanageable? Why is this surrender essential?"] },
                step2: { title: "Step 2: Coming to Believe", questions: [{ title: "Part 1: Understanding Insanity", isSection: true }, "In your own words, what does â€œinsanityâ€ mean in addiction (repeating destructive behavior expecting different results)?", "What specific behaviors or thought patterns in your addiction could be considered â€œinsaneâ€?", "How did your thinking become distorted while using (justifying, minimizing, denying)?", "Describe times when you made irrational or risky decisions because of your addiction.", "How did you try to manage your use after it became unmanageable? What were the results?", "In what ways did your addiction separate you from reality, loved ones, or your true self?", "What evidence shows that your best thinking wasnâ€™t enough to keep you safe or sober?", { title: "Part 2: Coming to Believe", isSection: true }, "What does the phrase â€œcame to believeâ€ mean to you? Is it a process or a sudden realization?", "What are your current beliefs about a Power greater than yourself (God, fellowship, universe)?", "Have you ever experienced something greater than yourself helping you through a difficult time?", "What evidence of a Higher Power have you seen in early recovery?", "How does the idea of surrendering control make you feel â€” fearful, hopeful, or relieved?", "What people or experiences have helped you begin to trust that change is possible?", "How does seeing others in recovery influence your belief that you can also recover?", { title: "Part 3: Restoration to Sanity", isSection: true }, "What does â€œsanityâ€ look like to you? How would a sane, balanced life differ from your old patterns?", "In what areas of your life do you feel restoration is already beginning?", "How do you imagine a Power greater than yourself could help you heal your thinking?", "What does spiritual growth mean to you at this stage of recovery?", "What signs of hope have you experienced since beginning this journey?", "What would it mean to truly trust the recovery process instead of trying to control it?", "How would your life look if you fully believed that recovery and peace of mind are possible for you?", { title: "Part 4: Acceptance and Openness", isSection: true }, "What fears or doubts do you still have about a Power greater than yourself?", "What is holding you back from fully believing that you can be restored to sanity?", "What would you need to let go of to move forward in faith?", "How can you stay open-minded as you explore your understanding of a Higher Power?", "How do you plan to strengthen your spiritual connection moving into Step Three?"] },
                step3: { title: "Step 3: Turning It Over", questions: [{ title: "Part 1: Understanding the Decision", isSection: true }, "In your own words, what does â€œmaking a decisionâ€ mean in recovery?", "How is believing (Step 2) different from deciding to turn your will over (Step 3)?", "What fears or reservations do you have about giving up control?", "What does â€œyour willâ€ mean to you? How has self-will influenced your past decisions?", "What has been the result when you tried to control everything yourself?", "In what areas of your life do you still struggle to let go and trust a Higher Power?", "What might your life look like if you truly surrendered those areas?", { title: "Part 2: Turning It Over", isSection: true }, "What does â€œturning your will and your life overâ€ look like in practical, daily terms?", "How can you begin to rely on a Higher Power instead of your own impulses and fears?", "Have you experienced moments when you felt guidance or strength beyond yourself? Describe them.", "What daily practices can help you maintain this connection (prayer, meditation, service)?", "What would it take for you to fully trust that this Power wants whatâ€™s best for you?", "How does humility play a role in Step Three?", "What does it mean to live â€œin Godâ€™s careâ€ rather than under your own direction?", { title: "Part 3: Willingness and Action", isSection: true }, "How do you know when you are being guided by self-will instead of spiritual will?", "What are some signs that you are resisting guidance or trying to take back control?", "How do you feel when you finally let go of something youâ€™ve been clinging to?", "What actions can you take today to show your willingness to live by spiritual principles?", "How do prayer and meditation help you align your will with your Higher Powerâ€™s will?", "How can you remind yourself each day that surrender is not weakness, but strength?", "How might turning your will and life over improve your relationships?", { title: "Part 4: Faith and Trust", isSection: true }, "What does faith mean to you, and how has it changed since entering recovery?", "What does â€œtrusting the processâ€ look like in your daily life?", "How can you show gratitude for the guidance and care youâ€™re beginning to experience?", "What would it feel like to live with complete trust in your Higher Power?", "How do you handle doubt or fear when you feel disconnected from that Power?", "Who or what helps you stay accountable to your decision to live spiritually?", "What is one situation right now that you can practice turning over fully to your Higher Power?", { title: "Part 5: Commitment and Renewal", isSection: true }, "Have you said or written your own version of the Step Three prayer? What does it mean to you?", "How can you demonstrate your decision in your everyday choices?", "What kind of person do you believe your Higher Power is helping you become?", "How do you want your recovery to reflect your growing faith and surrender?", "How will you keep renewing this decision, one day at a time?"] },
                step4: { title: "Step 4: Moral Inventory", questions: [{ title: "Part 1: Understanding Moral Inventory", isSection: true }, "What does 'searching and fearless moral inventory' mean to you?", "Why is it important to examine your resentments, fears, and harms to others?", "What do you hope to gain from doing this inventory honestly?", "What fears or hesitations do you have about doing Step Four?", "How does honesty with yourself play a role in your recovery?", { title: "Part 2: Resentments", isSection: true }, "List the people, institutions, or principles you resent. What did they do?", "How did each resentment affect your pride, self-esteem, security, or relationships?", "What part did you play in each situation? Were you selfish, dishonest, fearful, or inconsiderate?", "Have you been holding onto any old grudges that poison your peace of mind?", "What patterns can you identify in your resentments? What do they reveal about you?", { title: "Part 3: Fears", isSection: true }, "What are your greatest fearsâ€”past, present, and future?", "How have your fears influenced your decisions and behavior?", "Have you ever allowed fear to control your actions or relationships? Give examples.", "What do your fears reveal about your lack of faith or trust in a Higher Power?", "How might facing your fears honestly bring you closer to spiritual freedom?", { title: "Part 4: Harms to Others", isSection: true }, "List people you have harmed through your addiction or behavior.", "What specific actions did you take that hurt them (lying, manipulation, neglect)?", "How did these actions affect those people emotionally, financially, or spiritually?", "What part of your character was at play in each harm (selfishness, pride, fear)?", "How does recognizing these harms prepare you for making amends in Step Eight?", { title: "Part 5: Character Defects", isSection: true }, "What recurring traits keep causing problems in your life (dishonesty, jealousy, self-pity)?", "How have these defects shown up in your relationships and decisions?", "In what ways have these traits protected you or helped you survive in the past?", "Are you willing to let go of these defects, even the ones you think you 'need'?", "What would your life look like without these destructive patterns?"] },
                step5: { title: "Step 5: Admitting Wrongs", questions: [{ title: "Part 1: Understanding Step Five", isSection: true }, "What does Step Five mean to you personally?", "Why is it necessary to share your moral inventory with another person?", "How does admitting your wrongs to God, yourself, and another human being help you heal?", "What fears or doubts do you have about being completely honest in this step?", "What do you hope to gain from completing Step Five?", { title: "Part 2: Preparation for Step Five", isSection: true }, "Who have you chosen to share your Step Four inventory with, and why?", "What qualities make this person trustworthy and supportive of your recovery?", "How can you prepare emotionally and spiritually for this conversation?", "Are there any parts of your inventory you still feel hesitant or ashamed to share?", "What might happen if you hold back certain truths during your Step Five?", { title: "Part 3: The Experience of Sharing", isSection: true }, "Describe what it felt like to share your inventory openly with another person.", "Were there any surprises or realizations during the conversation?", "Did the person you shared with offer insights you hadnâ€™t considered before?", "How did it feel to be truly honest about things youâ€™ve hidden for years?", "What emotions surfaced during or after your Step Five (e.g., relief, guilt, peace)?", { title: "Part 4: Insights and Lessons Learned", isSection: true }, "What did you learn about yourself through this process?", "How did Step Five change your understanding of humility and accountability?", "What patterns of behavior became clearer after sharing your wrongs out loud?", "How has this step affected your connection with your Higher Power?", "Do you feel lighter or more at peace now that youâ€™ve shared your secrets? Explain.", { title: "Part 5: Moving Forward", isSection: true }, "What areas of your life feel ready for healing now?", "Are there amends or changes in behavior you already feel motivated to make?", "What practices will help you maintain honesty and humility going forward?", "How will you remind yourself to keep an open heart and mind as you continue?", "In what ways do you feel closer to freedom, forgiveness, and inner peace?"] },
                step6: { title: "Step 6: Becoming Ready", questions: [{ title: "Part 1: Understanding Step Six", isSection: true }, "What does 'entirely ready' mean to you in the context of this step?", "Why is it important to become ready for change rather than forcing it?", "What does it mean for God (or your Higher Power) to remove your defects of character?", "How is being 'ready' different from simply 'wanting' your defects removed?", "What fears do you have about letting go of your character defects?", { title: "Part 2: Identifying Character Defects", isSection: true }, "List the main defects of character from your Step Four and Step Five work.", "Which of these defects cause the most harm to yourself and others?", "Which of these traits do you still find useful or comforting, even though theyâ€™re destructive?", "What situations or emotions tend to trigger these defects?", "How do these defects block your connection with your Higher Power and your true self?", { title: "Part 3: Readiness for Change", isSection: true }, "Are you truly ready to let go of your most damaging character defects? Why or why not?", "What would your life look like without these behaviors or attitudes controlling you?", "What positive qualities could grow in place of these defects if they were removed?", "How can you practice willingness when youâ€™re not yet ready to change?", "What might be holding you back from total readiness for transformation?", { title: "Part 4: The Role of a Higher Power", isSection: true }, "How do you understand your Higher Powerâ€™s role in helping you change?", "Do you believe your Higher Power can and will remove your defects if you are ready?", "What spiritual practices (prayer, meditation, reflection) help you stay connected to willingness?", "How does humility play a part in this step?", "What does 'cooperating with grace' mean to you in the process of character change?", { title: "Part 5: Growth and Ongoing Readiness", isSection: true }, "How can you recognize when a defect begins to resurface in your life?", "What daily actions or attitudes help you stay willing to grow spiritually?", "How can you remind yourself that progress, not perfection, is the goal of this step?", "How do patience and persistence play a role in becoming entirely ready?", "What signs will show you that you are truly ready to move forward to Step Seven?"] },
                step7: { title: "Step 7: Humbly Asking", questions: [{ title: "Part 1: Understanding Step Seven", isSection: true }, "What does humility mean to you in the context of recovery?", "Why do you think humility is essential in asking for your shortcomings to be removed?", "How is Step Seven different from Step Six?", "What does it mean to 'ask' your Higher Power to remove your shortcomings?", "Why is it important to acknowledge that you cannot remove your defects on your own?", { title: "Part 2: The Nature of Humility", isSection: true }, "How has pride or ego interfered with your recovery and relationships?", "What are some examples of humility youâ€™ve witnessed in others?", "How can humility strengthen your connection with your Higher Power?", "What does it feel like to admit that you still need help and guidance?", "How do you balance self-respect with humility in your recovery journey?", { title: "Part 3: Asking for Removal of Shortcomings", isSection: true }, "Which specific shortcomings do you most want your Higher Power to remove right now?", "What daily actions can you take to cooperate with that spiritual process?", "How do you know when a shortcoming is being lifted or transformed in your life?", "How do prayer, meditation, or service help you practice Step Seven?", "What is the difference between asking for removal and expecting instant perfection?", { title: "Part 4: Living with Grace and Patience", isSection: true }, "Have you ever become frustrated that change wasnâ€™t happening fast enough? What did you learn?", "What helps you stay patient while your Higher Power works in your life?", "How can you show gratitude for progress, even when it feels slow?", "In what ways does practicing humility lead to serenity?", "How does accepting your humanity help you maintain compassion for yourself and others?", { title: "Part 5: Ongoing Practice of Step Seven", isSection: true }, "How can you make Step Seven a daily practice, not just a one-time event?", "What reminders or rituals help you stay connected to humility and faith?", "How do you notice your shortcomings returning, and how do you respond when they do?", "How can you use service to others as an expression of humility and gratitude?", "How will you carry the lessons of Step Seven into the next phase of your recovery journey?"] },
                step8: { title: "Step 8: List of Harms", questions: [{ title: "Part 1: Understanding Step Eight", isSection: true }, "What does it mean to make a list of all persons you have harmed?", "Why is willingness an important part of this step?", "How does Step Eight prepare you for Step Nine?", "What does 'harm' mean to youâ€”emotionally, financially, or spiritually?", "What fears or concerns come up for you when you think about making amends?", { title: "Part 2: Making the List", isSection: true }, "Who are the people you have harmed (family, friends, co-workers, etc.)?", "How did your actions or words harm them?", "Have you caused harm indirectly, such as neglecting responsibilities or breaking trust?", "Are there people youâ€™ve forgotten or minimized in your inventory?", "How can you ensure your list is honest, complete, and made in a spirit of humility?", { title: "Part 3: Understanding Harm and Responsibility", isSection: true }, "What patterns do you notice in the ways youâ€™ve harmed others?", "Were your actions driven by fear, selfishness, dishonesty, pride, or anger?", "How has your behavior affected the trust and safety of those around you?", "How does taking responsibility for harm done help you grow spiritually?", "Why is it important to forgive yourself as part of this process?", { title: "Part 4: Becoming Willing", isSection: true }, "Who are you willing to make amends to right now? Why?", "Who are you not yet willing to make amends to, and whatâ€™s holding you back?", "What would it take for you to become willing to make those amends?", "How can prayer, meditation, or talking with your sponsor help you find willingness?", "How does Step Eight connect with your spiritual growth and your desire for a better life?"] },
                step9: { title: "Step 9: Making Amends", questions: [{ title: "Part 1: Understanding Step Nine", isSection: true }, "What does 'making direct amends' mean to you?", "Why is it important to make amends 'wherever possible'?", "What does the phrase 'except when to do so would injure them or others' mean?", "How does this step differ from simply saying 'Iâ€™m sorry'?", "What fears or reservations do you have about making amends?", { title: "Part 2: Preparing to Make Amends", isSection: true }, "Review your Step Eight list. Who will you make amends to first, and why?", "How will you approach each person? What will you say?", "What is your motivation for making each amendâ€”is it to clear your conscience or to truly help heal?", "How can you stay humble and open to any reaction you might receive?", "Have you discussed your plan with your sponsor or a trusted advisor?", { title: "Part 3: The Act of Making Amends", isSection: true }, "Describe one of your experiences making a direct amend. What happened?", "How did the other person react? How did you feel?", "Were there any amends that were particularly difficult or surprising?", "How did you handle situations where you couldnâ€™t make a direct amend?", "What did you learn about forgiveness, humility, and courage through this process?", { title: "Part 4: Living Amends", isSection: true }, "How can you make 'living amends' by changing your behavior going forward?", "In what ways do your daily actions now reflect your commitment to recovery?", "How has making amends improved your relationships and your self-respect?", "What does it feel like to live with a cleaner conscience?", "How will you continue to practice honesty and responsibility in your relationships?", { title: "Part 5: Spiritual Growth and Freedom", isSection: true }, "How has Step Nine deepened your connection with your Higher Power?", "In what ways do you feel more spiritually free now?", "How has this step helped you let go of guilt and shame from the past?", "What does it mean to you to live with integrity and accountability?", "How will you carry the lessons of Step Nine into your daily life?"] },
                step10: { title: "Step 10: Daily Inventory", questions: [{ title: "Part 1: Understanding Step Ten", isSection: true }, "What does it mean to 'continue to take personal inventory'?", "Why is Step Ten a daily practice?", "How does this step help you stay on track with your recovery?", "What does 'when we were wrong promptly admitted it' mean in your daily life?", "How does Step Ten prevent resentments and character defects from building up again?", { title: "Part 2: Daily Inventory Practice", isSection: true }, "What is your routine for taking a daily inventory (e.g., at the end of the day, during quiet moments)?", "What questions do you ask yourself during your inventory?", "How do you identify when youâ€™ve been dishonest, selfish, resentful, or fearful?", "What do you do when you realize you were wrong in a situation?", "How do you make amends promptly when needed?", { title: "Part 3: Emotional Sobriety and Self-Awareness", isSection: true }, "How has Step Ten helped you become more aware of your emotions and reactions?", "What patterns in your behavior have you noticed through your daily inventories?", "How do you handle difficult emotions like anger, fear, or jealousy in a healthier way now?", "What does emotional sobriety mean to you, and how does Step Ten support it?", "How has your self-awareness grown since you started practicing this step?", { title: "Part 4: Spiritual Connection and Humility", isSection: true }, "How does your daily inventory help you stay connected to your Higher Power?", "In what ways does admitting your wrongs promptly keep you humble?", "How do you ask for guidance from your Higher Power when youâ€™re unsure about a situation?", "How has Step Ten improved your ability to listen to your conscience or inner voice?", "What does it feel like to go to bed with a clear conscience each night?", { title: "Part 5: A Way of Life", isSection: true }, "How has Step Ten become a natural part of your daily routine?", "What are the biggest benefits youâ€™ve experienced from practicing this step?", "How does Step Ten help you maintain balance and serenity in your life?", "In what ways does this step support your relationships with others?", "How will you continue to use Step Ten to grow spiritually and emotionally?"] },
                step11: { title: "Step 11: Prayer & Meditation", questions: [{ title: "Part 1: Understanding Step Eleven", isSection: true }, "What does 'conscious contact with God as we understood Him' mean to you?", "Why are both prayer and meditation important parts of this step?", "How do you see the difference between prayer and meditation?", "What does it mean to pray 'only for knowledge of His will for us and the power to carry that out'?", "How does this step help you deepen your spiritual connection?", { title: "Part 2: The Practice of Prayer", isSection: true }, "What is your personal approach to prayer? Is it formal, conversational, or something else?", "What do you pray for on a daily basis?", "How has your understanding of prayer changed since you started recovery?", "How do you handle times when you feel your prayers arenâ€™t being answered?", "In what ways does prayer help you align your will with your Higher Powerâ€™s will?", { title: "Part 3: The Practice of Meditation", isSection: true }, "What is your meditation practice like? How do you quiet your mind?", "What challenges do you face with meditation, and how do you overcome them?", "How does meditation help you listen for guidance from your Higher Power?", "What have you learned about yourself through your meditation practice?", "In what ways has meditation brought you peace, clarity, or serenity?", { title: "Part 4: Seeking Guidance and Power", isSection: true }, "How do you know when you are receiving guidance from your Higher Power?", "What does it feel like to act on that guidance, even when itâ€™s difficult?", "How does Step Eleven give you the strength and courage to face lifeâ€™s challenges?", "Describe a time when you felt spiritually connected and empowered.", "How does this step help you trust that you are on the right path?", { title: "Part 5: A Spiritual Way of Life", isSection: true }, "How has your spiritual life grown since you began practicing Step Eleven?", "What are the biggest benefits youâ€™ve experienced from prayer and meditation?", "How do you maintain your spiritual practice, especially on busy or stressful days?", "In what ways has your conscious contact with your Higher Power transformed your life?", "How will you continue to deepen your spiritual journey in the future?"] },
                step12: { title: "Step 12: Spiritual Awakening", questions: [{ title: "Part 1: Understanding Spiritual Awakening", isSection: true }, "What does a 'spiritual awakening' mean to you personally?", "How has your life changed as a result of working the first eleven steps?", "In what ways do you see the world and yourself differently now?", "How has your connection with your Higher Power grown through this process?", "What are some signs of your spiritual awakening in your daily thoughts and actions?", { title: "Part 2: Carrying the Message", isSection: true }, "What is the message of recovery that you have to share?", "Why is it important to carry this message to other addicts who are still suffering?", "How can you share your experience, strength, and hope with others in a helpful way?", "What opportunities do you have for service work (e.g., sponsorship, sharing at meetings)?", "How does helping others strengthen your own recovery?", { title: "Part 3: Practicing These Principles in All Our Affairs", isSection: true }, "What are the key spiritual principles youâ€™ve learned from the twelve steps (e.g., honesty, humility, forgiveness)?", "How can you apply these principles in your relationships with family and friends?", "How can you practice these principles at work or in your community?", "What does it look like to live with integrity and purpose in your daily life?", "How do you handle challenges and conflicts using the tools of the program?", { title: "Part 4: A Life of Recovery", isSection: true }, "How has your life been transformed by the twelve steps?", "What are you most grateful for in your recovery today?", "How do you continue to grow spiritually, emotionally, and mentally?", "What does it mean to you to live 'one day at a time'?", "How do you maintain your hope and commitment to recovery for the long term?", { title: "Part 5: The Journey Continues", isSection: true }, "What are your goals for the future in your recovery and in your life?", "How will you stay connected to the fellowship and your support system?", "What have you learned about yourself that will guide you in the years to come?", "How do you find joy, peace, and fulfillment in your sober life?", "What message of hope would you give to someone just starting their recovery journey?"] },
            }
        };

        // --- START: UTILS ---
        const DateUtils = {
            getFormattedDate: (date) => { const yyyy = date.getFullYear(); const mm = String(date.getMonth() + 1).padStart(2, '0'); const dd = String(date.getDate()).padStart(2, '0'); return `${yyyy}-${mm}-${dd}`; },
            formatDateForDisplayShort: (dateKey) => { if (!dateKey) return ''; const date = new Date(dateKey.replace(/-/g, '\/')); return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }); },
            formatDateForDisplay: (dateKey) => { if (!dateKey) return ''; const date = new Date(dateKey.replace(/-/g, '\/')); return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); },
            calculateDuration: (soberDateStr) => {
                if (!soberDateStr) return "Enter your date to start tracking!";
                const start = new Date(soberDateStr.replace(/-/g, '\/'));
                const now = new Date();
                if (start > now) return "Date must be in the past.";
                const diffTime = Math.abs(now - start);
                const MS_PER_DAY = 1000 * 60 * 60 * 24;
                const totalDays = Math.floor(diffTime / MS_PER_DAY);
                if (totalDays === 0) return "Sober for today!";
                const years = Math.floor(totalDays / 365.25);
                const remainingDaysAfterYears = totalDays - Math.floor(years * 365.25);
                const months = Math.floor(remainingDaysAfterYears / 30.44);
                const days = Math.round(remainingDaysAfterYears % 30.44);
                let output = [];
                if (years > 0) output.push(`${years} year${years !== 1 ? 's' : ''}`);
                if (months > 0) output.push(`${months} month${months !== 1 ? 's' : ''}`);
                if (days > 0) output.push(`${days} day${days !== 1 ? 's' : ''}`);
                return `Sober for ${output.join(', ')} (${totalDays} total days).`;
            }
        };
        const ViewManager = {
            _allViews: ['homeScreen', 'cardView', 'contentCardView'],
            showView(viewId) { this._allViews.forEach(id => { const el = document.getElementById(id); if (el) { el.style.display = (id === viewId) ? 'block' : 'none'; } }); },
            renderContentCard(title, subtitle, bodyHtml) { document.getElementById('contentCardTitle').textContent = title; document.getElementById('contentCardSub').textContent = subtitle; document.getElementById('contentCardBody').innerHTML = bodyHtml; this.showView('contentCardView'); }
        };
        const BaseButton = (id, text, extraClasses = '') => `<button id="${id}" class="py-2 px-4 rounded-lg font-semibold text-white bg-blue-500 hover:bg-blue-600 shadow-sm transition-colors duration-200 ${extraClasses}">${text}</button>`;
        const HomeButton = () => BaseButton('homeBtn', 'Home');

        // --- START: STORAGE ---
        const SOBER_DATE_KEY = 'soberDate'; const TODO_KEY = 'addictsAgendaTodoList'; const JOURNAL_KEY = 'addictsAgendaJournalEntries'; const PROMPT_KEY = 'addictsAgendaCustomPrompts';
        const WORKBOOK_KEYS = { step1: 'addictsAgendaWorkbookStep1', step2: 'addictsAgendaWorkbookStep2', step3: 'addictsAgendaWorkbookStep3', step4: 'addictsAgendaWorkbookStep4', step5: 'addictsAgendaWorkbookStep5', step6: 'addictsAgendaWorkbookStep6', step7: 'addictsAgendaWorkbookStep7', step8: 'addictsAgendaWorkbookStep8', step9: 'addictsAgendaWorkbookStep9', step10: 'addictsAgendaWorkbookStep10', step11: 'addictsAgendaWorkbookStep11', step12: 'addictsAgendaWorkbookStep12' };
        const get = (key) => localStorage.getItem(key); const set = (key, value) => localStorage.setItem(key, JSON.stringify(value));
        const _getWorkbookAnswers = (key, questions) => {
            const saved = get(key); const numQuestions = questions.filter(q => !q.isSection).length;
            if (saved) { try { const answers = JSON.parse(saved); if (Array.isArray(answers)) { if (answers.length < numQuestions) { return [...answers, ...Array(numQuestions - answers.length).fill('')]; } return answers.slice(0, numQuestions); } } catch (e) { /* ignore */ } }
            return Array(numQuestions).fill('');
        };
        const Storage = {
            saveSoberDate: (dateStr) => localStorage.setItem(SOBER_DATE_KEY, dateStr), loadSoberDate: () => localStorage.getItem(SOBER_DATE_KEY) || '',
            getTodoList: () => { try { return JSON.parse(get(TODO_KEY)) || []; } catch (e) { return []; } }, saveTodoList: (list) => set(TODO_KEY, list),
            getSavedEntries: () => { try { return JSON.parse(get(JOURNAL_KEY)) || {}; } catch (e) { return {}; } },
            saveEntry: (dateKey, content) => { const entries = Storage.getSavedEntries(); entries[dateKey] = content; set(JOURNAL_KEY, entries); },
            loadEntry: (dateKey) => Storage.getSavedEntries()[dateKey] || '',
            getCustomPrompts: () => { try { return JSON.parse(get(PROMPT_KEY)) || []; } catch (e) { return []; } }, saveCustomPrompts: (prompts) => set(PROMPT_KEY, prompts),
            getWorkbookAnswers: (stepKey, questions) => _getWorkbookAnswers(WORKBOOK_KEYS[stepKey], questions), saveWorkbookAnswers: (stepKey, answers) => set(WORKBOOK_KEYS[stepKey], answers),
        };

        // --- START: LOGIC MODULES ---
        let deck = [...AppData.cards];
        let currentCardText = '';
        const CardLogic = {
            suitColorMap: { blue: 'card-area-blue', green: 'card-area-green', orange: 'card-area-orange', purple: 'card-area-purple' },
            updateStatus: () => { document.getElementById('statusText').textContent = `Cards left in deck: ${deck.length} / 52`; },
            renderCard: (card) => { 
                const cardArea = document.getElementById('cardArea'); 
                document.getElementById('cardIcon').textContent = card.icon; 
                document.getElementById('cardSuit').textContent = card.suit; 
                document.getElementById('cardText').textContent = card.text; 
                currentCardText = card.text;
                cardArea.className = "min-h-[420px] rounded-2xl p-6 pt-10 flex flex-col items-center justify-between shadow-lg text-center transition-all duration-500 ease-in-out text-white"; 
                cardArea.classList.add(CardLogic.suitColorMap[card.suit_key] || ''); 
                CardLogic.updateStatus(); 
            },
            drawRandom: () => { if (deck.length === 0) return null; const idx = Math.floor(Math.random() * deck.length); return deck.splice(idx, 1)[0]; },
            drawAndDisplayCard: () => { const card = CardLogic.drawRandom(); if (card) { CardLogic.renderCard(card); ViewManager.showView('cardView'); } else { alert('Deck empty â€” please shuffle or return home.'); } },
            resetDeck: () => { deck = [...AppData.cards]; CardLogic.updateStatus(); ViewManager.showView('homeScreen'); },
            bindEventListeners: () => { 
                document.getElementById('nextBtn').addEventListener('click', CardLogic.drawAndDisplayCard); 
                document.getElementById('resetBtn').addEventListener('click', CardLogic.resetDeck); 
                document.getElementById('journalBtn').addEventListener('click', () => JournalLogic.showJournalWithCopingCard(currentCardText));
            }
        };
        const ReflectionLogic = {
            fetchWithRetry: async (userQuery, systemPrompt) => {
                const payload = { contents: [{ parts: [{ text: userQuery }] }], tools: [{ "google_search": {} }], systemInstruction: { parts: [{ text: systemPrompt }] }, }; const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                for (let i = 0; i < 3; i++) { try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (response.ok) { const result = await response.json(); const text = result.candidates?.[0]?.content?.parts?.[0]?.text; if (text) return text; } } catch (error) { console.error(`Attempt ${i + 1} failed:`, error); if (i < 2) await new Promise(res => setTimeout(res, 1000 * (i + 1))); } }
                return "Could not load reflection. Please check your connection and try again.";
            },
            displayReflection: (resultText, quoteEl, readingEl, spinnerEl) => { spinnerEl.style.display = 'none'; const parts = resultText.split('\n\n'); if (parts.length >= 2 && !resultText.toLowerCase().includes("error")) { quoteEl.textContent = parts[0].trim().replace(/^['"]|['"]$/g, ''); readingEl.innerHTML = parts.slice(1).join('<br><br>').trim(); } else { quoteEl.textContent = "Error: Content not found."; readingEl.textContent = resultText; } quoteEl.style.display = 'block'; readingEl.style.display = 'block'; },
            _showViewTemplate: (idPrefix, title, subtitle, dateStr, callback) => {
                const body = `<label for="${idPrefix}DateInput" class="block text-center text-gray-600 mb-2">Select Date:</label><input type="date" id="${idPrefix}DateInput" class="block mx-auto max-w-xs w-full p-2 border border-gray-300 rounded-lg"><div id="${idPrefix}Content" class="min-h-[250px] flex flex-col justify-center items-center text-center p-4 bg-gray-50 rounded-lg border border-gray-200 mt-4"><div class="border-4 border-gray-200 border-t-blue-600 rounded-full w-8 h-8 animate-spin mx-auto my-5" id="${idPrefix}Spinner"></div><p id="${idPrefix}Quote" class="text-xl italic text-gray-800 mb-4" style="display:none;"></p><p id="${idPrefix}Reading" class="text-gray-700 leading-relaxed" style="display:none;"></p></div><div class="mt-5 flex justify-end">${HomeButton()}</div>`;
                ViewManager.renderContentCard(title, subtitle, body);
                const dateInput = document.getElementById(`${idPrefix}DateInput`); const today = DateUtils.getFormattedDate(new Date()); dateInput.value = dateStr || today; dateInput.max = today; callback(dateInput.value);
                dateInput.addEventListener('change', (e) => callback(e.target.value)); document.getElementById('homeBtn').addEventListener('click', () => ViewManager.showView('homeScreen'));
            },
            showReflectionView: (dateStr = null) => { ReflectionLogic._showViewTemplate('reflection', 'Daily Reflection (AA)', 'A daily quote and meditation to guide your thoughts.', dateStr, ReflectionLogic.getDailyReflection); },
            getDailyReflection: async (dateStr) => { const spinner = document.getElementById('reflectionSpinner'); const quoteEl = document.getElementById('reflectionQuote'); const readingEl = document.getElementById('reflectionReading');[quoteEl, readingEl].forEach(el => el.style.display = 'none'); spinner.style.display = 'block'; const query = `Find the AA Daily Reflection for ${DateUtils.formatDateForDisplay(dateStr)}. Provide only the central quote and the main reflection text. Format with the quote first, a double newline, then the reading.`; const system = "You are an assistant that finds and formats the AA Daily Reflection for a given date via Google Search."; const result = await ReflectionLogic.fetchWithRetry(query, system); ReflectionLogic.displayReflection(result, quoteEl, readingEl, spinner); },
            showJFTView: (dateStr = null) => { ReflectionLogic._showViewTemplate('jft', 'Just for Today (NA)', 'The daily spiritual message from Narcotics Anonymous.', dateStr, ReflectionLogic.getJustForToday); },
            getJustForToday: async (dateStr) => { const spinner = document.getElementById('jftSpinner'); const quoteEl = document.getElementById('jftQuote'); const readingEl = document.getElementById('jftReading');[quoteEl, readingEl].forEach(el => el.style.display = 'none'); spinner.style.display = 'block'; const query = `Find the NA Just For Today (JFT) reflection for ${DateUtils.formatDateForDisplay(dateStr)}. Provide only the central quote/theme and the main reflection text. Format with the quote/theme first, a double newline, then the reading.`; const system = "You are an assistant that finds and formats the NA Just For Today reflection for a given date via Google Search."; const result = await ReflectionLogic.fetchWithRetry(query, system); ReflectionLogic.displayReflection(result, quoteEl, readingEl, spinner); }
        };
        const SettingsLogic = {
            showSettingsView: () => {
                const savedDate = Storage.loadSoberDate(); const body = `<div class="space-y-4"><h3 class="text-xl font-semibold border-b pb-2 text-gray-700">Sober Date Tracking</h3><label for="soberDateInput" class="block font-medium text-gray-600">Your Sober Date:</label><input type="date" id="soberDateInput" value="${savedDate}" max="${DateUtils.getFormattedDate(new Date())}" class="w-full p-2 border border-gray-300 rounded-lg"><p id="sobrietyDuration" class="text-center font-bold text-blue-600 min-h-[24px]">${DateUtils.calculateDuration(savedDate)}</p></div><div class="mt-6 flex justify-end gap-3">${BaseButton('saveSettingsBtn', 'Save Date')}${HomeButton()}</div>`;
                ViewManager.renderContentCard('App Settings', 'Track your journey.', body);
                const dateInput = document.getElementById('soberDateInput'); const durationEl = document.getElementById('sobrietyDuration');
                dateInput.addEventListener('input', () => { durationEl.textContent = DateUtils.calculateDuration(dateInput.value); });
                document.getElementById('saveSettingsBtn').addEventListener('click', () => { const dateStr = dateInput.value; if (dateStr && new Date(dateStr) <= new Date()) { Storage.saveSoberDate(dateStr); const durationText = DateUtils.calculateDuration(dateStr); durationEl.textContent = durationText; document.getElementById('homeSobrietyDuration').textContent = durationText; alert('Sober date saved!'); } else { alert('Please enter a valid date in the past.'); } });
                document.getElementById('homeBtn').addEventListener('click', () => ViewManager.showView('homeScreen'));
            }
        };
        const LiteratureLogic = {
            showLiteratureView: () => {
                const body = `<div class="space-y-6"><div class="p-4 border border-gray-200 rounded-lg"><h3 class="text-xl font-bold text-blue-600 border-b-2 border-blue-200 pb-2 mb-3">Chapter 1: Bill's Story</h3><p class="text-justify leading-relaxed text-gray-600">Bill W.'s story is the compelling account of how the co-founder of Alcoholics Anonymous discovered his powerlessness over alcohol and, through a spiritual experience, found a way out. It details his descent into alcoholism and the visit from his friend, Ebby T., whose own recovery planted the seed for the program.</p></div><div class="p-4 border border-gray-200 rounded-lg"><h3 class="text-xl font-bold text-blue-600 border-b-2 border-blue-200 pb-2 mb-3">Chapter 2: There is a Solution</h3><p class="text-justify leading-relaxed text-gray-600">This chapter provides hope by asserting that recovery is possible. It emphasizes the importance of the fellowship and introduces the core concept that alcoholism is a threefold diseaseâ€”physical, mental, and spiritualâ€”requiring a spiritual remedy.</p></div></div><p class="mt-8 text-center italic text-gray-500">For the complete text, download the <a href="https://aa.org/the-big-book" target="_blank" class="text-blue-600 font-semibold hover:underline">Big Book Online</a>.</p><div class="mt-8 flex justify-end">${HomeButton()}</div>`;
                ViewManager.renderContentCard('Recovery Literature: Big Book Excerpts', 'Read key foundational texts from the fellowship.', body);
                document.getElementById('homeBtn').addEventListener('click', () => ViewManager.showView('homeScreen'));
            }
        };
        const JournalLogic = {
            _render: () => { const jEntry = document.getElementById('journalEntryView'); const jList = document.getElementById('journalListView'); const pManager = document.getElementById('promptManagerView'); if (jEntry) JournalLogic.showJournalEntryView(currentJournalKey); else if (jList) JournalLogic.showJournalListView(); else if (pManager) JournalLogic.showPromptManagerView(); },
            showJournalWithCopingCard: (cardText) => {
                JournalLogic.showJournalEntryView();
                setTimeout(() => {
                    const textarea = document.getElementById('journalEntry');
                    const copingCardTemplate = AppData.DEFAULT_PROMPTS.find(p => p.name === "Coping Card Reflection")?.template;
                    if (textarea && copingCardTemplate) {
                        const populatedTemplate = copingCardTemplate.replace('[Insert Card Text Here]', cardText);
                        if (textarea.value.trim() !== '' && !textarea.value.includes(cardText)) {
                            if (confirm("Append coping card reflection to your current entry?")) {
                                textarea.value += `\n\n${populatedTemplate}`;
                            }
                        } else {
                            textarea.value = populatedTemplate;
                        }
                    }
                }, 0);
            },
            showJournalEntryView: (dateKey = null) => {
                currentJournalKey = dateKey || DateUtils.getFormattedDate(new Date()); const prompts = [...AppData.DEFAULT_PROMPTS, ...Storage.getCustomPrompts()]; const promptOptions = prompts.map(p => `<option value="${p.template}">${p.name}</option>`).join('');
                const body = `<div id="journalEntryView"><div class="flex justify-between items-center mb-4"><label for="entryDate" class="font-semibold text-gray-700">Date:</label><input type="date" id="entryDate" value="${currentJournalKey}" max="${DateUtils.getFormattedDate(new Date())}" class="p-2 border border-gray-300 rounded-lg"></div><div class="flex gap-2 items-center mb-4"><select id="promptSelect" class="flex-grow p-2 border border-gray-300 rounded-lg bg-white">${promptOptions}</select>${BaseButton('managePromptsBtn', 'Manage', 'py-2 px-3 !bg-white !text-gray-700 border border-gray-300 hover:!bg-gray-100')}</div><textarea id="journalEntry" class="w-full h-64 p-3 border border-gray-300 rounded-lg" placeholder="What's on your mind today?">${Storage.loadEntry(currentJournalKey)}</textarea><div class="mt-6 flex justify-between items-center">${BaseButton('viewAllEntriesBtn', 'View All', '!bg-white !text-gray-700 border border-gray-300 hover:!bg-gray-100')}<div class="flex gap-3">${BaseButton('saveJournalBtn', 'Save')}${HomeButton()}</div></div></div>`;
                const title = `Reflection for ${DateUtils.formatDateForDisplay(currentJournalKey)}`; ViewManager.renderContentCard(title, "Use this space to process cravings, track progress, or reflect.", body);
                document.getElementById('entryDate').addEventListener('change', (e) => JournalLogic.showJournalEntryView(e.target.value)); document.getElementById('promptSelect').addEventListener('change', JournalLogic.handlePromptSelect); document.getElementById('managePromptsBtn').addEventListener('click', JournalLogic.showPromptManagerView); document.getElementById('saveJournalBtn').addEventListener('click', JournalLogic.handleSave); document.getElementById('viewAllEntriesBtn').addEventListener('click', JournalLogic.showJournalListView); document.getElementById('homeBtn').addEventListener('click', () => ViewManager.showView('homeScreen'));
            },
            showJournalListView: () => {
                const entries = Storage.getSavedEntries(); const sortedKeys = Object.keys(entries).sort().reverse();
                const listItems = sortedKeys.length ? sortedKeys.map(key => `<li class="flex justify-between items-center py-3 border-b border-gray-200"><span>${DateUtils.formatDateForDisplay(key)}</span>${BaseButton(`view-entry-${key}`, 'View', '!py-1 !px-3 !bg-white !text-gray-700 border border-gray-300 hover:!bg-gray-100 view-entry-btn')}</li>`).join('') : '<li class="text-center text-gray-500 py-4">No entries saved yet.</li>';
                const body = `<div id="journalListView"><ul class="list-none p-0">${listItems}</ul><div class="mt-6 flex justify-between items-center">${BaseButton('newEntryBtn', "Write Today's Entry")}${HomeButton()}</div></div>`;
                ViewManager.renderContentCard('Journal Entries', '', body);
                document.querySelectorAll('.view-entry-btn').forEach(btn => btn.addEventListener('click', (e) => { const key = e.target.id.replace('view-entry-',''); JournalLogic.showJournalEntryView(key);})); document.getElementById('newEntryBtn').addEventListener('click', () => JournalLogic.showJournalEntryView()); document.getElementById('homeBtn').addEventListener('click', () => ViewManager.showView('homeScreen'));
            },
            showPromptManagerView: () => {
                const prompts = Storage.getCustomPrompts(); const promptItems = prompts.length ? prompts.map((p, i) => `<li class="flex justify-between items-center py-2 border-b border-gray-200"><span class="text-gray-700">${p.name}</span><button class="delete-prompt-btn py-1 px-3 rounded-md font-semibold text-white bg-red-500 hover:bg-red-600" data-index="${i}">Delete</button></li>`).join('') : '<li class="text-center text-gray-500 py-4">No custom prompts.</li>';
                const body = `<div id="promptManagerView"><div class="flex gap-2 mb-4"><input type="text" id="customPromptInput" placeholder="Enter new prompt text..." class="flex-grow p-2 border border-gray-300 rounded-lg">${BaseButton('addCustomPromptBtn', 'Add')}</div><ul class="list-none p-0">${promptItems}</ul><div class="mt-6 flex justify-end">${BaseButton('backToEntryBtn', 'Back to Journal')}</div></div>`;
                ViewManager.renderContentCard('Manage Custom Prompts', 'Click a prompt to delete it.', body);
                document.getElementById('addCustomPromptBtn').addEventListener('click', JournalLogic.handlePromptAdd); document.querySelectorAll('.delete-prompt-btn').forEach(btn => btn.addEventListener('click', (e) => { if (confirm('Are you sure you want to delete this prompt?')) { let prompts = Storage.getCustomPrompts(); prompts.splice(e.target.dataset.index, 1); Storage.saveCustomPrompts(prompts); JournalLogic._render(); } })); document.getElementById('backToEntryBtn').addEventListener('click', () => JournalLogic.showJournalEntryView(currentJournalKey));
            },
            handleSave: () => { const content = document.getElementById('journalEntry').value; const dateKey = document.getElementById('entryDate').value; if (content.trim() === '') return alert('Journal entry is empty.'); if (dateKey) { Storage.saveEntry(dateKey, content); alert(`Entry for ${dateKey} saved!`); } else { alert('Please select a date.'); } },
            handlePromptAdd: () => { const input = document.getElementById('customPromptInput'); if (input.value.trim()) { let prompts = Storage.getCustomPrompts(); prompts.push({ name: input.value.trim(), template: input.value.trim() }); Storage.saveCustomPrompts(prompts); JournalLogic._render(); } else { alert('Please enter prompt text.'); } },
            handlePromptSelect: (event) => { const template = event.target.value; const textarea = document.getElementById('journalEntry'); if (template && (textarea.value.trim() === "" || confirm("Apply template? This will overwrite your current entry."))) { textarea.value = template; } event.target.selectedIndex = 0; }
        };
        const TodoLogic = {
            getRecurrenceLabel: (key) => ({ daily: 'Daily', weekly: 'Weekly', biweekly: 'Bi-Weekly', monthly: 'Monthly', yearly: 'Yearly' }[key] || 'No Repeat'),
            _render: () => {
                TodoLogic.updateRecurringTasks();
                const list = Storage.getTodoList().sort((a, b) => {
                    if (a.completed !== b.completed) { return a.completed ? 1 : -1; }
                    if (a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate);
                    return a.dueDate ? -1 : 1;
                });
                const listEl = document.getElementById('todoList');
                if (!listEl) return;
                listEl.innerHTML = list.length ? list.map((item, index) => {
                    const details = [];
                    if (item.dueDate) details.push(`Due: ${DateUtils.formatDateForDisplayShort(item.dueDate)}`);
                    if (item.recurrence && item.recurrence !== 'none') details.push(`Repeats: ${TodoLogic.getRecurrenceLabel(item.recurrence)}`);
                    return `
                        <li class="flex flex-col py-3 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <span class="todo-text flex-grow cursor-pointer ${item.completed ? 'line-through text-gray-400' : 'text-gray-700'}" data-index="${index}">${item.task}</span>
                                <div class="flex items-center gap-2">
                                    ${!item.completed ? `<button class="complete-todo-btn py-1 px-3 rounded-md font-semibold text-white bg-blue-500 hover:bg-blue-600" data-index="${index}">Complete</button>` : ''}
                                    <button class="delete-todo-btn py-1 px-3 rounded-md font-semibold text-white bg-red-500 hover:bg-red-600" data-index="${index}">Delete</button>
                                </div>
                            </div>
                            ${details.length ? `<div class="text-sm text-gray-500 mt-1">${details.join(' | ')}</div>` : ''}
                        </li>`;
                }).join('') : '<li class="text-center text-gray-500 py-4">Your list is clear!</li>';
                
                document.querySelectorAll('.todo-text').forEach(el => el.addEventListener('click', (e) => TodoLogic.toggleTodoComplete(e.target.dataset.index)));
                document.querySelectorAll('.complete-todo-btn').forEach(el => el.addEventListener('click', (e) => TodoLogic.handleCompleteTask(e.target.dataset.index)));
                document.querySelectorAll('.delete-todo-btn').forEach(el => el.addEventListener('click', (e) => TodoLogic.deleteTodo(e.target.dataset.index)));
            },
            showTodoView: () => {
                const body = `<div id="todoView"><div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4 items-end"><input type="text" id="todoInput" placeholder="Task description" class="p-2 border border-gray-300 rounded-lg md:col-span-2"><input type="date" id="todoDateInput" class="p-2 border border-gray-300 rounded-lg bg-white"><select id="todoRecurrenceSelect" class="p-2 border border-gray-300 rounded-lg bg-white"><option value="none">No Repeat</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="biweekly">Every 2 Weeks</option><option value="monthly">Monthly</option><option value="yearly">Yearly</option></select>${BaseButton('addTodoBtn', 'Add Task', 'w-full md:col-span-2')}</div><ul id="todoList" class="list-none p-0"></ul><div class="mt-6 flex justify-end">${HomeButton()}</div></div>`;
                ViewManager.renderContentCard('My To Do List', 'Keep track of small, actionable tasks.', body);
                document.getElementById('addTodoBtn').addEventListener('click', TodoLogic.addTodo);
                document.getElementById('homeBtn').addEventListener('click', () => ViewManager.showView('homeScreen'));
                TodoLogic._render();
            },
            addTodo: () => {
                const input = document.getElementById('todoInput');
                if (input.value.trim()) {
                    const list = Storage.getTodoList();
                    list.push({ task: input.value.trim(), completed: false, dueDate: document.getElementById('todoDateInput').value || '', recurrence: document.getElementById('todoRecurrenceSelect').value || 'none' });
                    Storage.saveTodoList(list);
                    input.value = ''; document.getElementById('todoDateInput').value = ''; document.getElementById('todoRecurrenceSelect').value = 'none';
                    TodoLogic._render();
                } else { alert('Please enter a task description.'); }
            },
            handleCompleteTask: (index) => {
                const list = Storage.getTodoList(); const item = list[index]; if (!item) return;
                if (item.recurrence !== 'none' && item.dueDate) {
                    let nextDate = new Date(item.dueDate.replace(/-/g, '\/'));
                    switch (item.recurrence) {
                        case 'daily': nextDate.setDate(nextDate.getDate() + 1); break;
                        case 'weekly': nextDate.setDate(nextDate.getDate() + 7); break;
                        case 'biweekly': nextDate.setDate(nextDate.getDate() + 14); break;
                        case 'monthly': nextDate.setMonth(nextDate.getMonth() + 1); break;
                        case 'yearly': nextDate.setFullYear(nextDate.getFullYear() + 1); break;
                    }
                    list.push({ task: item.task, completed: false, dueDate: DateUtils.getFormattedDate(nextDate), recurrence: item.recurrence });
                    item.recurrence = 'none'; // Detach from series
                }
                item.completed = true; Storage.saveTodoList(list); TodoLogic._render();
            },
            toggleTodoComplete: (index) => {
                const list = Storage.getTodoList();
                if (list[index] && list[index].recurrence === 'none') { list[index].completed = !list[index].completed; Storage.saveTodoList(list); TodoLogic._render(); }
            },
            deleteTodo: (index) => {
                if (confirm("Are you sure you want to permanently delete this task?")) { const list = Storage.getTodoList(); list.splice(index, 1); Storage.saveTodoList(list); TodoLogic._render(); }
            },
            updateRecurringTasks: () => { let list = Storage.getTodoList(); const todayStr = DateUtils.getFormattedDate(new Date()); let updated = false; list.forEach(item => { if (!item.completed && item.recurrence !== 'none' && item.dueDate && item.dueDate < todayStr) { let nextDate = new Date(item.dueDate.replace(/-/g, '\/')); while (DateUtils.getFormattedDate(nextDate) <= todayStr) { switch (item.recurrence) { case 'daily': nextDate.setDate(nextDate.getDate() + 1); break; case 'weekly': nextDate.setDate(nextDate.getDate() + 7); break; case 'biweekly': nextDate.setDate(nextDate.getDate() + 14); break; case 'monthly': nextDate.setMonth(nextDate.getMonth() + 1); break; case 'yearly': nextDate.setFullYear(nextDate.getFullYear() + 1); break; } } item.dueDate = DateUtils.getFormattedDate(nextDate); updated = true; } }); if (updated) Storage.saveTodoList(list); }
        };
        const WorkbookLogic = {
             updateWorkbookCompletionStats: () => {
                let grandTotalQuestions = 0;
                let grandTotalAnswered = 0;

                Object.keys(AppData.WORKBOOK_STEP_DATA).forEach((stepKey) => {
                    const stepData = AppData.WORKBOOK_STEP_DATA[stepKey];
                    const questions = stepData.questions.filter(q => !q.isSection);
                    const answers = Storage.getWorkbookAnswers(stepKey, stepData.questions);
                    const totalQuestions = questions.length;
                    const answeredQuestions = answers.filter(a => a && a.trim() !== '').length;

                    grandTotalQuestions += totalQuestions;
                    grandTotalAnswered += answeredQuestions;

                    const percentage = totalQuestions > 0 ? Math.round((answeredQuestions / totalQuestions) * 100) : 0;
                    
                    const stepButtonPercentSpan = document.querySelector(`.workbook-step-btn[data-step="${stepKey}"] .workbook-percent`);
                    if (stepButtonPercentSpan) {
                        stepButtonPercentSpan.textContent = `${percentage}%`;
                    }
                });

                const overallPercentage = grandTotalQuestions > 0 ? Math.round((grandTotalAnswered / grandTotalQuestions) * 100) : 0;

                const mainWorkbookBtn = document.getElementById('goToWorkbooksBtn');
                if (mainWorkbookBtn) {
                    let percentSpan = mainWorkbookBtn.querySelector('.overall-workbook-percent');
                    if (!percentSpan) {
                        percentSpan = document.createElement('span');
                        percentSpan.className = 'overall-workbook-percent opacity-70 font-normal ml-2';
                        mainWorkbookBtn.appendChild(percentSpan);
                    }
                    percentSpan.textContent = `(${overallPercentage}%)`;
                }
            },
            _renderStep: (stepKey) => {
                const stepData = AppData.WORKBOOK_STEP_DATA[stepKey]; const answers = Storage.getWorkbookAnswers(stepKey, stepData.questions); let answerIndex = 0; let isFirstSection = true;
                const questionsHtml = stepData.questions.map(q => { if (q.isSection) { const html = `${isFirstSection ? '' : '</div>'}<div class="workbook-section-header mt-4 -mx-6 px-6 py-2 bg-gray-100 border-t border-b border-gray-200 cursor-pointer flex justify-between items-center ${isFirstSection ? '' : 'collapsed'}"><h3 class="text-lg font-bold text-gray-700">${q.title}</h3><span class="collapse-icon text-xl text-gray-500">â–¼</span></div><div class="section-content px-1 ${isFirstSection ? '' : 'collapsed'}">`; isFirstSection = false; return html; } else { const html = `<div class="pt-4"><h4 class="font-semibold text-gray-800 mb-2">${answerIndex + 1}. ${q}</h4><textarea data-question-index="${answerIndex}" class="w-full h-32 p-2 border border-gray-300 rounded-lg" placeholder="Write your honest answer here...">${answers[answerIndex] || ''}</textarea></div>`; answerIndex++; return html; } }).join('') + '</div>';
                const body = `<div id="workbookView" data-step="${stepKey}">${questionsHtml}<p id="saveStatus" class="text-green-600 font-semibold h-6 mt-4"></p><div class="mt-6 flex justify-between items-center">${BaseButton('backToWorkbooksBtn', 'All Steps')}<div class="flex gap-3">${BaseButton('saveWorkbookBtn', 'Save')}${HomeButton()}</div></div></div>`;
                ViewManager.renderContentCard(stepData.title, '', body);
                document.querySelectorAll('.workbook-section-header').forEach(header => { header.addEventListener('click', () => { header.classList.toggle('collapsed'); header.nextElementSibling.classList.toggle('collapsed'); }); });
                document.getElementById('saveWorkbookBtn').addEventListener('click', () => WorkbookLogic.collectAndSave(stepKey)); document.getElementById('backToWorkbooksBtn').addEventListener('click', WorkbookLogic.showWorkbooksHome); document.getElementById('homeBtn').addEventListener('click', () => ViewManager.showView('homeScreen'));
            },
            showWorkbooksHome: () => {
                const stepButtons = Object.keys(AppData.WORKBOOK_STEP_DATA).map((key) => `<button class="workbook-step-btn w-full text-left py-3 px-5 rounded-xl border-0 bg-blue-600 text-white font-semibold shadow-lg shadow-blue-500/30 cursor-pointer transition-colors duration-200 hover:bg-blue-700 relative" data-step="${key}">${AppData.WORKBOOK_STEP_DATA[key].title}<span class="workbook-percent absolute right-5 top-1/2 -translate-y-1/2 text-white/70"></span></button>`).join('');
                const body = `<div class="space-y-3">${stepButtons}</div><div class="mt-8 flex justify-between items-center">${BaseButton('exportPdfBtn', 'Export All to PDF')}${HomeButton()}</div>`;
                ViewManager.renderContentCard('Recovery Workbooks', 'Tools and step work resources.', body);
                WorkbookLogic.updateWorkbookCompletionStats();
                document.querySelectorAll('.workbook-step-btn').forEach(btn => btn.addEventListener('click', (e) => WorkbookLogic._renderStep(e.currentTarget.dataset.step)));
                document.getElementById('exportPdfBtn').addEventListener('click', WorkbookLogic.exportAllToPdf);
                document.getElementById('homeBtn').addEventListener('click', () => ViewManager.showView('homeScreen'));
            },
            collectAndSave: (stepKey) => { 
                const answers = Array.from(document.querySelectorAll('#workbookView textarea')).map(t => t.value); 
                Storage.saveWorkbookAnswers(stepKey, answers); 
                const statusEl = document.getElementById('saveStatus'); 
                statusEl.textContent = 'Progress Saved!'; 
                setTimeout(() => { statusEl.textContent = ''; }, 3000); 
                WorkbookLogic.updateWorkbookCompletionStats();
            },
            exportAllToPdf: () => {
                const { jsPDF } = window.jspdf; const doc = new jsPDF(); const margin = 15; const pageHeight = doc.internal.pageSize.getHeight(); let y = margin;
                doc.setFontSize(22); doc.text("The Addict's Agenda - Workbook Answers", doc.internal.pageSize.getWidth() / 2, y, { align: 'center' }); y += 15;
                Object.keys(AppData.WORKBOOK_STEP_DATA).forEach((stepKey) => {
                    const stepData = AppData.WORKBOOK_STEP_DATA[stepKey]; const answers = Storage.getWorkbookAnswers(stepKey, stepData.questions); let answerIndex = 0;
                    if (y + 15 > pageHeight - margin) { doc.addPage(); y = margin; }
                    doc.setFontSize(18); doc.text(stepData.title, margin, y); y += 10;
                    stepData.questions.forEach(q => {
                        if (q.isSection) { if (y + 10 > pageHeight - margin) { doc.addPage(); y = margin; } doc.setFontSize(14); doc.text(q.title, margin, y, { fontStyle: 'bold' }); y += 8; }
                        else {
                            const questionText = `${answerIndex + 1}. ${q}`; const answerText = answers[answerIndex] || 'No answer provided.'; doc.setFontSize(12); const splitQuestion = doc.splitTextToSize(questionText, doc.internal.pageSize.getWidth() - margin * 2);
                            if (y + (splitQuestion.length * 5) > pageHeight - margin) { doc.addPage(); y = margin; } doc.text(splitQuestion, margin, y); y += splitQuestion.length * 5;
                            doc.setFontSize(11); doc.setTextColor(80, 80, 80); const splitAnswer = doc.splitTextToSize(answerText, doc.internal.pageSize.getWidth() - margin * 2 - 5);
                            if (y + (splitAnswer.length * 5) > pageHeight - margin) { doc.addPage(); y = margin; } doc.text(splitAnswer, margin + 5, y); y += splitAnswer.length * 5 + 5; doc.setTextColor(0, 0, 0);
                            answerIndex++;
                        }
                    });
                    y += 5;
                });
                doc.save('addicts-agenda-workbooks.pdf');
            }
        };

        // --- START: APP INITIALIZATION ---
        const App = {
            initializeApp: function() {
                this.loadDailyFact(); const savedDate = Storage.loadSoberDate(); document.getElementById('homeSobrietyDuration').textContent = DateUtils.calculateDuration(savedDate); 
                WorkbookLogic.updateWorkbookCompletionStats();
                ViewManager.showView('homeScreen'); this.bindEventListeners();
            },
            loadDailyFact: async function() {
                const factElement = document.getElementById('dailyFactText'); const query = "Provide a single, interesting, and encouraging fact or quote about addiction recovery. It should be one to two sentences long."; const system = "You are an assistant providing inspiring facts for an addiction recovery app.";
                const factText = await ReflectionLogic.fetchWithRetry(query, system);
                factElement.textContent = factText.includes("Could not load") ? "Remember: One day at a time." : factText.trim();
            },
            bindEventListeners: function() {
                document.getElementById('goToCardsBtn').addEventListener('click', CardLogic.drawAndDisplayCard);
                document.getElementById('goToJournalBtn').addEventListener('click', () => JournalLogic.showJournalEntryView());
                document.getElementById('goToTodoBtn').addEventListener('click', TodoLogic.showTodoView);
                document.getElementById('goToReflectionBtn').addEventListener('click', () => ReflectionLogic.showReflectionView());
                document.getElementById('goToJFTBtn').addEventListener('click', () => ReflectionLogic.showJFTView());
                document.getElementById('goToSettingsBtn').addEventListener('click', SettingsLogic.showSettingsView);
                document.getElementById('goToLiteratureBtn').addEventListener('click', LiteratureLogic.showLiteratureView);
                document.getElementById('goToWorkbooksBtn').addEventListener('click', WorkbookLogic.showWorkbooksHome);
                CardLogic.bindEventListeners();
            }
        };
        App.initializeApp();
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js').then(reg => console.log('SW registered.')).catch(err => console.log('SW registration failed: ', err)); }
    });
  </script>
</body>
</html>

